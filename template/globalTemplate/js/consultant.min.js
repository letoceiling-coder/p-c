!function (t, e) {
    for (var n in e) t[n] = e[n]
}(this, function (t) {
    function e(a) {
        if (n[a]) return n[a].exports;
        var s = n[a] = {exports: {}, id: a, loaded: !1};
        return t[a].call(s.exports, s, s.exports, e), s.loaded = !0, s.exports
    }

    var n = {};
    return e.m = t, e.c = n, e.p = "", e(0)
}([function (t, e) {
    Comagic.UI.registerViewController("consultant", function (t, e) {
        function n() {
            return t.chat.is_visible && (nt.consultant_chat.isChatAvailable() || ["chat", "invite"].indexOf(nt.consultant_chat.getState()) !== -1)
        }

        function a() {
            return t.offline_message.is_visible && (!t.chat.is_visible || !nt.consultant_chat.isChatAvailable())
        }

        function s() {
            return n() || a()
        }

        function i() {
            var t = !1;
            if (Comagic.UI.getWidget("sitephone")) {
                var e = Comagic.UI.getWidget("sitephone").settings;
                t = e.is_visible && (e.is_schedule_active || e.is_always_displayed)
            }
            return t
        }

        function c() {
            var t = !1;
            if (Comagic.UI.getWidget("sitephone")) {
                var e = Comagic.UI.getWidget("sitephone").settings;
                t = e.is_visible && e.v_position === Z.top && e.h_position === Z.left && (e.is_schedule_active || e.is_always_displayed)
            }
            return t
        }

        function o(e) {
            return {
                consultant_label: function () {
                    switch (e) {
                        case"consultant_invite":
                        case"rack":
                            return s();
                        default:
                            return !1
                    }
                }(), consultant_chat_label_icon: n(), rack: !0, consultant_invite: function () {
                    var n = t.chat.is_visible && !nt.consultant_chat.isVisible() && "invite" === nt.consultant_chat.getState();
                    switch (e) {
                        case"rack":
                        case"consultant_invite":
                            return n;
                        default:
                            return !1
                    }
                }(), consultant_chat_group_selector: function () {
                    switch (e) {
                        case"consultant_chat":
                        case"consultant_chat_group_selector":
                            return t.chat.is_groups_enabled && "available" === nt.consultant_chat.getState() && !y() && !W;
                        default:
                            return !1
                    }
                }(), consultant_chat: function () {
                    switch (e) {
                        case"consultant_invite":
                            return nt.consultant_chat.isVisible();
                        case"consultant_chat":
                            return !0;
                        default:
                            return !1
                    }
                }(), consultant_offline_message: "consultant_offline_message" === e
            }
        }

        function l(t) {
            for (var e in t) t.hasOwnProperty(e) && nt[e] && (t[e] ? ["consultant_chat", "consultant_chat_group_selector"].indexOf(e) === -1 && Comagic.UI.Mobile.isFullSizeMode() || !nt[e].isVisible() && nt[e].show() : nt[e].isVisible() && nt[e].hide())
        }

        function r(t) {
            g(), t.consultant_chat_label_icon ? (nt.consultant_label.getEl().classList.add("comagic-js-consultant-label--chat"), nt.consultant_label.getEl().classList.remove("comagic-js-consultant-label--offline-message")) : (nt.consultant_label.getEl().classList.add("comagic-js-consultant-label--offline-message"), nt.consultant_label.getEl().classList.remove("comagic-js-consultant-label--chat"))
        }

        function u() {
            return nt.consultant_chat.refs.log.scrollHeight > nt.consultant_chat.refs.log.offsetHeight
        }

        function _() {
            nt.consultant_chat.refs.log.scrollTop = nt.consultant_chat.refs.log.scrollHeight
        }

        function g() {
            nt.consultant_label.refs.counter.innerHTML = nt.consultant_chat.getUnreadCounter() || ""
        }

        function d(t) {
            nt.consultant_chat.refs.headerTitle.innerHTML = t
        }

        function f(t) {
            var e = Comagic.UI.getWidget(t.widgetName);
            return function (n) {
                var a = t.feedbackClassName || "comagic-js-show-feedback--" + (n.success ? "success" : "failure");
                e.refs.content && (e.refs.content.classList.add(a), n.info && (e.refs.feedbackTitle.innerHTML = n.info.title, e.refs.feedbackMessage.innerHTML = n.info.message)), window.setTimeout(function () {
                    t.doAfterSubmit && t.doAfterSubmit(n), t.isClear && e.refs.content.classList.remove(a)
                }, t.delayAfterSubmit || 3e3)
            }
        }

        function h(n) {
            var a = n.isHistoryMode, s = n.sender, i = n.name;
            return function (n, c) {
                var o, l, r = nt[c].refs.log, g = n.fx_link ? "_file_" : "_";
                return n.sender = s || n.sender, n.v_position = t.chat.v_position, n.h_position = t.chat.h_position, l = c + "_" + n.sender + g + i, o = Comagic.UI.createWidget(l, {
                    settings: n,
                    tpl: e[l]
                }), o.render(r, a && r.firstChild), a ? (it[c].last && it[c].last.getEl() && it[c].last.settings.sender === n.sender && o.getEl().classList.remove("comagic-js-last-message"), it[c].last = o) : (it[c].first && it[c].first.getEl() && it[c].first.settings.sender === n.sender && it[c].first.getEl().classList.remove("comagic-js-last-message"), it[c].first = o), setTimeout(function () {
                    o.getEl().classList.remove("comagic-js-consultant-message--hidden")
                }, 1), nt.consultant_chat.isVisible() && "operator" === n.sender && nt.consultant_chat.clearUnreadCounter(), a || u() && _(), o
            }
        }

        function m(t) {
            nt.consultant_chat.refs.messageEditor.classList[t ? "add" : "remove"]("comagic-js-messages-editor--ready-for-send")
        }

        function b() {
            nt.consultant_invite.destroy(), O.destroy()
        }

        function v() {
            var t = nt.consultant_chat.refs.messageCreator, e = !!t && t.innerText.trim() || "";
            e && (ut(nt.consultant_chat.sendChatMessage(e, y()), "consultant_chat"), "invite" === nt.consultant_chat.getState() && (nt.consultant_chat.inviteAccept(), b())), t.innerHTML = "", m(!1)
        }

        function p() {
            nt.consultant_chat.getRequiredInfo().length ? S(v) : v()
        }

        function w() {
            nt.consultant_chat.refs.messageEditor.classList.add("comagic-js-messages-editor--disabled"), nt.consultant_chat.refs.messageCreator.setAttribute("contenteditable", !1)
        }

        function L() {
            nt.consultant_chat.refs.messageEditor.classList.remove("comagic-js-messages-editor--disabled"), nt.consultant_chat.refs.messageCreator.setAttribute("contenteditable", !0)
        }

        function C() {
            E(null)
        }

        function E(t) {
            Comagic.storage.setItem("_cmg_current_group_id", t)
        }

        function y() {
            return Comagic.storage.getItem("_cmg_current_group_id")
        }

        function S(e) {
            var n = ct({chat: t.chat, sender: "bot"}, "consultant_chat");
            W = !0, w(), n.refs.submitBtn.addEventListener("click", function () {
                n.getErrors() || nt.consultant_chat.setVisitorCard(n.getValues(), function () {
                    n.refs.content.classList.add("comagic-js-show-feedback"), L(), W = !1, e()
                })
            })
        }

        function k() {
            s() && !nt.consultant_label.isVisible() && nt.consultant_label.show(), nt.consultant_invite.is_consultant_invite_inited && !nt.consultant_invite.isVisible() && nt.consultant_invite.show(), i() && !Comagic.UI.getWidget("sitephone_label").isVisible() && Comagic.UI.getWidget("sitephone_label").show()
        }

        function I(t) {
            nt.consultant_chat.refs.ratingBtn.classList[t ? "add" : "remove"]("comagic-js-rating-btn-hidden")
        }

        function T(t) {
            var e = [8, 13, 37, 38, 39, 40, 46], n = !1;
            return e.indexOf(t.which) === -1 && e.indexOf(t.keyCode) === -1 || (n = !0), n
        }

        function U(t, e) {
            if (t.childNodes[0]) {
                var n = t.childNodes[0];
                if (n && n.length >= e) {
                    var a = window.document.createRange(), s = window.getSelection();
                    a.setStart(n, e), a.collapse(!0), s.removeAllRanges(), s.addRange(a)
                }
            }
        }

        function j() {
            var e = t.chat.is_groups_enabled && nt.consultant_chat_group_selector.isVisible(),
                n = nt.consultant_chat.getOperatorVcard(), a = e ? t.chat.group_title : t.chat.title;
            return n && "available" !== nt.consultant_chat.getState() && (a = (n.position + "<br>" + n.name).trim()), a
        }

        function x() {
            nt.consultant_invite && nt.consultant_invite.getEl() && (Comagic.UI.Mobile.updateLabelStyles(nt.consultant_invite.getEl(), X, null, null, null), nt.consultant_invite.refs.log.style.height = "", nt.consultant_invite.refs.log.style.height = nt.consultant_invite.getEl().offsetHeight + "px", Comagic.UI.Mobile.updateLabelStyles(nt.consultant_invite.getEl(), null, null, {
                top: "middle" === Z.top ? "middle-fixed" : Z.top,
                left: Z.left
            }, {top: c() ? q + F - tt : "middle" === Z.top ? -F : F, left: K + z + 5}))
        }

        function M() {
            for (var t = 90 === Math.abs(window.orientation) ? "add" : "remove", e = 0; e < N.length; e++) {
                var n = N[e];
                nt[n].getEl(".comagic-c-consultant-container__content").classList[t]("comagic-js-consultant-container--hidden"), nt[n].getEl(".comagic-c-consultant-container__landscape").classList[t]("comagic-js-consultant-container--shown")
            }
        }

        function H(t) {
            for (var e = ["comagic-c-field", "comagic-c-messages-editor__creator", "comagic-c-select--select"], n = !1, a = 0; a < e.length; a++) if (t.classList.contains(e[a])) {
                n = !0;
                break
            }
            return n
        }

        var V, B, O, R, A, W, D, N = ["consultant_chat", "consultant_offline_message"], P = !1, z = 15, q = 17, F = 7,
            K = 7, G = 6, J = 3, Q = {width: 5, height: 5, fontSize: J},
            X = {width: 70, minHeight: 15, maxHeight: 35, fontSize: J}, Y = null,
            Z = {top: t.chat.v_position, left: t.chat.h_position}, $ = "middle" === Z.top ? z / 2 + F : 0,
            tt = "middle" === Z.top ? z + F : 0, et = function () {
                var n = Array.prototype.slice.call(arguments), a = {
                    do: function (t, e, s) {
                        (s || n).forEach(function (n) {
                            a[n][t].apply(a[n], e)
                        })
                    }
                };
                return n.forEach(function (n) {
                    a[n] = Comagic.UI.createWidget(n, {
                        settings: t, tpl: e[n], getHelperSelector: function () {
                            return "comagic-js-" + this.name.replace(new RegExp("_", "g"), "-")
                        }, show: function (t) {
                            var e = this;
                            return t ? (D.pub(n), !1) : void setTimeout(function () {
                                e.getEl().classList.remove(e.getHelperSelector() + "--hidden"), e.getEl().classList.add(e.getHelperSelector() + "--shown"), "consultant_invite" !== e.name || e.is_consultant_invite_inited || x(), N.indexOf(e.name) !== -1 && Comagic.UI.Mobile.form()
                            }, 0)
                        }, hide: function (t) {
                            var e = this;
                            e.getEl().classList.remove(e.getHelperSelector() + "--shown"), e.getEl().classList.add(e.getHelperSelector() + "--hidden"), N.indexOf(e.name) !== -1 && Comagic.UI.Mobile.unform()
                        }
                    })
                }), a
            },
            nt = et("consultant_label", "consultant_invite", "consultant_chat", "consultant_offline_message", "consultant_chat_group_selector"),
            at = ["consultant_chat", "consultant_offline_message"], st = ["consultant_label", "consultant_invite"],
            it = {consultant_invite: {last: null, first: null}, consultant_chat: {last: null, first: null}},
            ct = h({name: "vcard_message", sender: "bot"}), ot = h({name: "rating_message", sender: "bot"}),
            lt = h({name: "retention_btn_message", sender: "bot"}), rt = h({name: "message", isHistoryMode: !0}),
            ut = h({name: "message"});
        nt.do("render", null, at), nt.do("render", null, st), nt.do("render", [nt.consultant_chat.refs.groupSelector], ["consultant_chat_group_selector"]), nt.consultant_label.refs.triggerOfflineMessage.addEventListener("click", function () {
            D.pub("consultant_offline_message")
        }), nt.consultant_offline_message.on("sendofflinerequest", f({
            widgetName: "consultant_offline_message",
            isClear: !0,
            doAfterSubmit: function () {
                nt.consultant_offline_message.refs.submitBtn.classList.remove("comagic-js-button--disabled"), nt.consultant_offline_message.refs.closeBtn.classList.remove("comagic-js-close-btn-hidden"), D.pub("rack")
            }
        })), nt.consultant_offline_message.refs.closeBtn.addEventListener("click", function () {
            D.pub("rack"), k()
        }), nt.consultant_offline_message.refs.submitBtn.addEventListener("click", function () {
            nt.consultant_offline_message.getErrors() || (nt.consultant_offline_message.refs.submitBtn.classList.add("comagic-js-button--disabled"), nt.consultant_offline_message.refs.closeBtn.classList.add("comagic-js-close-btn-hidden"), nt.consultant_offline_message.sendRequest(nt.consultant_offline_message.getValues()))
        }), "available" === nt.consultant_chat.getState() && C(), t.chat.is_groups_enabled && (nt.consultant_chat_group_selector.refs.groups.forEach(function (t) {
            t.addEventListener("click", function (t) {
                E(t.target.dataset.groupId), D.pub("consultant_chat")
            })
        }), nt.consultant_chat_group_selector.on("show", function () {
            d(t.chat.group_title)
        }), nt.consultant_chat_group_selector.on("hide", function () {
            "available" === nt.consultant_chat.getState() && d(t.chat.title)
        })), nt.consultant_label.on("show", g), nt.consultant_label.refs.triggerChat.addEventListener("click", function () {
            D.pub("consultant_chat")
        }), nt.consultant_chat.refs.closeBtn.addEventListener("click", function () {
            D.pub("rack"), k(), "invite" === nt.consultant_chat.getState() && (nt.consultant_chat.inviteReject(), b())
        }), nt.consultant_chat.on("messageviewed", g), nt.consultant_chat.on("show", function () {
            "available" !== nt.consultant_chat.getState() && nt.consultant_chat.clearUnreadCounter(), u() && setTimeout(function () {
                _()
            }, 500)
        }), nt.consultant_chat.refs.ratingBtn && nt.consultant_chat.refs.ratingBtn.addEventListener("click", function () {
            var t = ot(nt.consultant_chat.getOperatorVcard() || {sender: "bot"}, "consultant_chat");
            t.refs.thumbsUpBtn.addEventListener("click", function () {
                nt.consultant_chat.setOperatorRating(5), t.refs.content.classList.add("comagic-js-show-feedback")
            }), t.refs.thumbsDownBtn.addEventListener("click", function () {
                nt.consultant_chat.setOperatorRating(1), t.refs.content.classList.add("comagic-js-show-feedback")
            }), I(!0)
        }), nt.consultant_chat.refs.messageCreator.addEventListener("paste", function (t) {
            var e, n = this, a = n.getAttribute("c-max");
            e = window.clipboardData ? window.clipboardData.getData("Text") : t.clipboardData.getData("text/plain"), e = n.innerText + e, e >= a ? n.innerText = e.slice(0, a) : n.innerText = e, U(n, n.innerText.length), n.scrollTop = 1e4, t.preventDefault()
        }), nt.consultant_chat.refs.messageCreator.addEventListener("keydown", function (t) {
            var e = this;
            return !t.ctrlKey && !T(t) && e.innerText.length >= e.getAttribute("c-max") ? (t.preventDefault(), !1) : (nt.consultant_chat.chatTyping(e.textContent || ""), void (13 !== t.which && 13 !== t.keyCode || t.shiftKey || (p(), t.preventDefault())))
        }), nt.consultant_chat.refs.messageCreator.addEventListener("keyup", function () {
            var t = this;
            m(t.innerHTML.length > 0)
        }), nt.consultant_chat.refs.textPusher.addEventListener("click", p), nt.consultant_chat.refs.filePusher.addEventListener("change", function () {
            nt.consultant_chat.sendFile(this)
        }), nt.consultant_chat.on("ratingchange", function (t) {
            I(!!t)
        }), nt.consultant_chat.on("chatavailabilitychange", function () {
            nt.consultant_chat.isVisible() || nt.consultant_offline_message.isVisible() || D.pub("rack")
        }), nt.consultant_chat.on("showchatretentionaction", function (t) {
            var e = lt(Comagic.UI.C.RETENTION_BUTTONS_SETTINGS[t.alternate_communication_way], "consultant_chat");
            e.refs.submitBtn.addEventListener("click", function () {
                nt.consultant_chat.closeChat(function () {
                    "sitephone" === t.alternate_communication_way ? Comagic.openSitePhonePanel() : "chat" === t.alternate_communication_way ? (C(), Comagic.openChatWindow()) : "offline_message" === t.alternate_communication_way && Comagic.openSiteRequestPanel()
                })
            })
        }), nt.consultant_chat.on("showhistory", function (t) {
            for (var e = null; t.length;) e = t.shift(), ut(e, "consultant_chat")
        }), nt.consultant_chat.on("sendmessage", function (t) {
            "operator" === t.sender && nt.consultant_chat.refs.typingIndicator.classList.remove("comagic-js-is-typing"), ut(t, "consultant_chat"), g()
        }), nt.consultant_chat.on("operatorjoined", function (t, e) {
            d(j())
        }), d(j()), nt.consultant_chat.refs.log.addEventListener("scroll", function (t) {
            var e, n, a, s = nt.consultant_chat.refs.log;
            if (0 === s.scrollTop && (e = nt.consultant_chat.getHistory(), a = s.scrollHeight, e)) {
                for (n = 0; n < e.length; n++) rt(e[n], "consultant_chat");
                s.scrollTop = s.scrollHeight - a, t.preventDefault()
            }
        }), nt.consultant_chat.on("chattyping", function () {
            clearTimeout(A), nt.consultant_chat.refs.typingIndicator.classList.add("comagic-js-is-typing"), A = setTimeout(function () {
                nt.consultant_chat.refs.typingIndicator.classList.remove("comagic-js-is-typing")
            }, 5e3)
        }), nt.consultant_chat.on("statechange", function (t) {
            switch (t) {
                case"chat":
                    D.pub("consultant_chat");
                    break;
                case"invite":
                    D.pub("consultant_invite");
                    break;
                default:
                    !nt.consultant_chat.isVisible() && D.pub("rack"), d(j())
            }
        }), nt.consultant_chat.on("invite", function (e) {
            t.chat.is_visible && (ut(e, "consultant_chat"), "operator" === e.sender && (nt.consultant_chat.isVisible() || (D.pub("consultant_invite"), nt.consultant_invite.is_consultant_invite_inited = !0, Comagic.UI.getWidget("consultant_invite_operator_message") && Comagic.UI.getWidget("consultant_invite_operator_message").destroy(), O = ut(e, "consultant_invite"), O.on("beforeshow", function () {
                R = "consultant_invite_operator_message", Comagic.UI.Mobile.updateLabelStyles(O.refs.closeBtn, {
                    width: G,
                    minWidth: G,
                    height: G,
                    top: -6.5,
                    borderRadius: G / 2
                }, null, null, null), Comagic.UI.Mobile.updateLabelStyles(O.getEl(), {borderRadius: 2}, null, null, null), Comagic.UI.Mobile.updateLabelStyles(O.getEl(".comagic-c-invite-bubble__avatar"), {
                    width: 13,
                    height: 13,
                    padding: 2
                }, null, null, null), Comagic.UI.Mobile.updateLabelStyles(O.getEl(".comagic-c-invite-bubble__text"), {
                    width: 55,
                    paddingTop: 1,
                    paddingRight: 1
                }, null, null, null);
                var t = {borderWidth: 3};
                "top" === Z.top ? t.top = 5 : t.bottom = 5, "left" === Z.left ? t.left = -5 : t.right = -5, Comagic.UI.Mobile.updateLabelStyles(O.getEl(".comagic-c-invite-bubble__triangle"), t, null, null, null), x()
            }), k(), O.show(), O.refs.acceptBtn.addEventListener("click", function () {
                D.pub("consultant_chat"), nt.consultant_chat.inviteAccept(), b()
            }), O.refs.closeBtn.addEventListener("click", function () {
                nt.consultant_chat.inviteReject(), b()
            }))))
        }), nt.consultant_label.on("beforeshow", function () {
            V = "consultant_label", Comagic.UI.Mobile.updateLabelStyles(nt.consultant_label.getEl(), {
                width: z,
                height: z,
                fontSize: J
            }, null, Z, {
                top: c() ? q + F - $ : "middle" === Z.top ? 0 : F,
                left: K
            }), Comagic.UI.Mobile.updateLabelStyles(nt.consultant_label.refs.counter, Q, null, null, null)
        }), nt.consultant_invite.is_consultant_invite_inited = !1, nt.consultant_invite.on("beforeshow", function () {
            nt.consultant_invite.is_consultant_invite_inited || nt.consultant_invite.getEl().classList.add("comagic-js-consultant-invite--hidden"), B = "consultant_invite", x()
        }), M(), window.addEventListener("orientationchange", function () {
            M(), document.activeElement && H(document.activeElement) && document.activeElement.blur()
        }), Comagic.on("ui:actionstart", function () {
            Y = !0, "consultant_label" === V && nt.consultant_label.hide(), "consultant_invite" === B && nt.consultant_invite.hide(), "consultant_invite_operator_message" === R && O.hide()
        }), Comagic.on("ui:actionend", function () {
            Y = !1, Comagic.UI.Mobile.isFullSizeMode() || P || ("consultant_label" === V && nt.consultant_label.show(), "consultant_invite" === B && nt.consultant_invite.show(), "consultant_invite_operator_message" === R && O.show())
        }), D = Comagic.UI.createObserver(o), D.sub(l), D.sub(r), D.pub("hide_all"), D.pub("rack"), Comagic.on("sleep", function () {
            D.pub("hide_all"), P = !0
        })
    })
}]));